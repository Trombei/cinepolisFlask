{% extends "base.html" %}
{% block content %}
<div class="checkout-container">
    <h2>Comprar boletos para: {{ peli.titulo }}</h2>
    
    <form method="POST" class="compra-form">
        {{ form.hidden_tag() }}
        
        <div class="form-group">
            {{ form.nombre.label }}
            {{ form.nombre(class="input-field") }}
        </div>

        <div class="form-group">
            {{ form.correo.label }}
            {{ form.correo(class="input-field", type="email") }}
        </div>

        <div class="form-group">
            {{ form.cantidad.label }}
            {{ form.cantidad(class="input-field", min="1", max="7", id="input-cantidad") }}
            {% for error in form.cantidad.errors %}
                <span class="error-text">[{{ error }}]</span>
            {% endfor %}
        </div>

        <div class="form-group checkbox-group">
            {{ form.tarjeta_cineco(id="check-cineco") }}
            {{ form.tarjeta_cineco.label }}
        </div>

        <div class="live-calc-panel">
            <p>Subtotal: $<span id="calc-sub">12.00</span> USD</p>
            <p class="desc-text">Descuento aplicado (<span id="calc-porcentaje">0</span>%): -$<span id="calc-desc">0.00</span> USD</p>
            <h3 class="total-text">Total a Pagar: $<span id="calc-total">12.00</span> USD</h3>
        </div>

        <div class="botones-compra">
            <a href="{{ url_for('movie', movie_id=peli.id) }}" class="btn-secundario">Regresar</a>
            {{ form.submit(class="btn-primario submit-btn") }}
        </div>
    </form>
</div>

<script>
    const precioBoleto = 12.0;
    const inputCantidad = document.getElementById('input-cantidad');
    const checkCineco = document.getElementById('check-cineco');
    
    const spanSub = document.getElementById('calc-sub');
    const spanDesc = document.getElementById('calc-desc');
    const spanPorc = document.getElementById('calc-porcentaje');
    const spanTotal = document.getElementById('calc-total');

    function actualizarPrecios() {
        let cantidad = parseInt(inputCantidad.value) || 0;
        
        if(cantidad < 0) cantidad = 0;
        if(cantidad > 7) cantidad = 7;

        let subtotal = cantidad * precioBoleto;
        let descuentoDecimal = 0.0;

        if (cantidad > 3) descuentoDecimal += 0.10; 
        if (checkCineco.checked) descuentoDecimal += 0.10; 

        let ahorro = subtotal * descuentoDecimal;
        let total = subtotal - ahorro;

        spanSub.innerText = subtotal.toFixed(2);
        spanDesc.innerText = ahorro.toFixed(2);
        spanPorc.innerText = (descuentoDecimal * 100).toFixed(0);
        spanTotal.innerText = total.toFixed(2);
    }

    inputCantidad.addEventListener('input', actualizarPrecios);
    checkCineco.addEventListener('change', actualizarPrecios);
    
    window.onload = actualizarPrecios;
</script>
{% endblock %}